<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¸ìˆ˜ì½”ë“œ - ë©€í‹°ë£¸ ì±„íŒ…</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0;
            height: 100vh; display: grid; grid-template-rows: auto 1fr;
            background-color: #f4f6f9;
        }

        header {
            background: white; padding: 15px 20px; border-bottom: 1px solid #ddd;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .control-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        #workspace {
            display: grid; grid-template-columns: 260px 1fr; overflow: hidden;
        }

        #sidebar {
            background: #2c3e50; color: white; padding: 15px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .room-tab {
            padding: 12px; background: #34495e; border-radius: 6px;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: 0.2s; font-size: 0.95em;
        }
        .room-tab:hover { background: #3e5871; }
        .room-tab.active { background: #fff; color: #333; font-weight: bold; border-left: 5px solid #007bff; }
        .close-btn { font-size: 0.8em; opacity: 0.6; padding: 2px 6px; }
        .close-btn:hover { opacity: 1; color: #ff4d4d; background: rgba(255,255,255,0.8); border-radius: 3px; }

        #mainChatArea { display: flex; flex-direction: column; padding: 20px; background: #fff; }
        #chatOutput {
            flex-grow: 1; border: 1px solid #e9ecef; border-radius: 8px;
            padding: 20px; margin-bottom: 15px; overflow-y: scroll; background: #f8f9fa;
        }
        #chatHeader { margin-bottom: 10px; font-weight: bold; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #allRoomList { list-style: none; padding: 0; margin: 0; display: flex; gap: 8px; flex-wrap: wrap; }
        #allRoomList li {
            background: #e9ecef; padding: 5px 12px; border-radius: 15px;
            font-size: 0.85em; cursor: pointer; border: 1px solid #ced4da;
        }
        #allRoomList li:hover { background: #007bff; color: white; border-color: #007bff; }

        .msg-row { margin: 8px 0; }
        .room-badge { background: #6c757d; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-right: 6px; }
        .sender { font-weight: bold; color: #0056b3; margin-right: 5px; }
        .system { color: #888; font-size: 0.85em; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>

<header>
    <div class="control-row">
        <h2 style="margin:0; margin-right:20px;">ğŸ’¬ ë©€í‹°ë£¸ ì±„íŒ…</h2>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„">
        <button id="setNicknameButton">ì„¤ì •</button>
    </div>
    <div class="control-row" style="background:#f8f9fa; padding:10px; border-radius:8px;">
        <span style="font-weight:bold; color:#555;">ğŸŒ ì „ì²´ ë°© ëª©ë¡:</span>
        <ul id="allRoomList"><li style="color:#aaa">ë¡œë”© ì¤‘...</li></ul>
        <div style="margin-left:auto; display:flex; gap:5px;">
            <input type="text" id="roomInput" placeholder="ë°© ì´ë¦„" style="width:120px;">
            <button id="joinRoomButton" disabled>ì°¸ê°€/ìƒì„±</button>
        </div>
    </div>
</header>

<div id="workspace">
    <div id="sidebar">
        <h3 style="margin:0 0 10px 0; border-bottom:1px solid #4b6584; padding-bottom:10px;">ğŸ“‚ ë‚´ ì±„íŒ…ë°©</h3>
        <div id="myTabsContainer">
            <div style="color:#bdc3c7; font-size:0.9em; text-align:center; padding:20px;">ì°¸ì—¬ ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="mainChatArea">
        <div id="chatHeader">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        <div id="chatOutput"><p class="system">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</p></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="messageInput" placeholder="ì™¼ìª½ì—ì„œ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”" disabled style="flex-grow:1;">
            <button id="sendButton" disabled>ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    const ws = new WebSocket("ws://localhost:8080");

    // --- ìƒíƒœ ë³€ìˆ˜ ---
    let currentTargetRoom = null; // í˜„ì¬ 'ë³´ê³  ìˆëŠ”' ë°©
    let myJoinedRooms = [];       // ë‚´ê°€ ë“¤ì–´ê°„ ë°© ëª©ë¡

    // ë°©ë³„ ë©”ì‹œì§€ ì €ì¥ì†Œ (Key: ë°©ì´ë¦„, Value: HTMLë¬¸ìì—´ ë°°ì—´)
    const roomMessages = {};

    // --- DOM ìš”ì†Œ ---
    const chatOutput = document.getElementById("chatOutput");
    const chatHeader = document.getElementById("chatHeader");
    const allRoomListUl = document.getElementById("allRoomList");
    const myTabsContainer = document.getElementById("myTabsContainer");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");

    // --- í™”ë©´ ì¶œë ¥ í•¨ìˆ˜ ---
    function appendToScreen(html) {
        const div = document.createElement("div");
        div.innerHTML = html;
        chatOutput.appendChild(div);
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    // --- [í•µì‹¬ ë¡œì§] ë©”ì‹œì§€ ì²˜ë¦¬ ë° ë¶„ë°° ---
    function processIncomingMessage(roomName, htmlContent) {
        // 1. í•´ë‹¹ ë°©ì˜ ì €ì¥ì†Œê°€ ì—†ìœ¼ë©´ ë§Œë“¦
        if (!roomMessages[roomName]) {
            roomMessages[roomName] = [];
        }

        // 2. ë©”ëª¨ë¦¬ì— ì €ì¥
        roomMessages[roomName].push(htmlContent);

        // 3. ë§Œì•½ ë‚´ê°€ 'ì§€ê¸ˆ ë³´ê³  ìˆëŠ” ë°©'ì´ë¼ë©´ í™”ë©´ì—ë„ ë°”ë¡œ ê·¸ë¦¼
        if (currentTargetRoom === roomName) {
            appendToScreen(htmlContent);
        }
    }

    // --- í—¬í¼: JSON ì „ì†¡ ---
    function sendJson(type, payload) {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type, payload }));
        }
    }

    // --- ì‚¬ì´ë“œë°” ë Œë”ë§ ---
    function renderMySidebar() {
        myTabsContainer.innerHTML = "";

        if (myJoinedRooms.length === 0) {
            myTabsContainer.innerHTML = "<div style='color:#bdc3c7; font-size:0.9em; text-align:center; padding:20px;'>ì°¸ì—¬ ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>";
            messageInput.disabled = true;
            sendButton.disabled = true;
            messageInput.placeholder = "ë°©ì— ë¨¼ì € ì°¸ê°€í•´ì£¼ì„¸ìš”";
            chatHeader.innerText = "ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
            return;
        }

        myJoinedRooms.forEach(roomName => {
            const div = document.createElement("div");
            const isActive = (currentTargetRoom === roomName);
            div.className = `room-tab ${isActive ? 'active' : ''}`;
            div.onclick = () => selectRoom(roomName);
            div.innerHTML = `
                <span onclick="selectRoom('${roomName}')">${roomName}</span>
                <span class="close-btn" onclick="leaveRoom('${roomName}')" title="ë‚˜ê°€ê¸°">âœ•</span>
            `;
            myTabsContainer.appendChild(div);
        });

        // ì…ë ¥ì°½ í™œì„±í™” ìƒíƒœ ê°±ì‹ 
        if (currentTargetRoom) {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = `[${currentTargetRoom}] ë°©ì— ë©”ì‹œì§€ ë³´ë‚´ê¸°...`;
            messageInput.focus();
            chatHeader.innerText = `ğŸ“‚ í˜„ì¬ ëŒ€í™” ì¤‘: ${currentTargetRoom}`;
        }
    }

    // --- [í•µì‹¬] ë°© ì„ íƒ (íƒ­ í´ë¦­) ---
    function selectRoom(roomName) {
        currentTargetRoom = roomName;

        // 1. í™”ë©´ì„ ê¹¨ë—ì´ ì§€ì›€
        chatOutput.innerHTML = "";

        // 2. ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê·¸ ë°©ì˜ ëŒ€í™” ë‚´ìš©ë§Œ ë‹¤ì‹œ ê·¸ë¦¼
        if (roomMessages[roomName]) {
            roomMessages[roomName].forEach(html => {
                appendToScreen(html);
            });
        } else {
            // ë©”ì‹œì§€ê°€ í•˜ë‚˜ë„ ì—†ëŠ” ìƒˆ ë°©ì´ë©´ ì´ˆê¸°í™”
            roomMessages[roomName] = [];
        }

        renderMySidebar(); // íƒ­ ìŠ¤íƒ€ì¼(Active) ê°±ì‹ 
    }

    // --- ë°© ë‚˜ê°€ê¸° ---
    function leaveRoom(roomName) {
        if (confirm(`'${roomName}' ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            sendJson("LEAVE_ROOM", roomName);

            // ëª©ë¡ì—ì„œ ì œê±° & ë©”ëª¨ë¦¬ ì‚­ì œ
            myJoinedRooms = myJoinedRooms.filter(r => r !== roomName);
            delete roomMessages[roomName];

            if (currentTargetRoom === roomName) {
                currentTargetRoom = myJoinedRooms.length > 0 ? myJoinedRooms[0] : null;
                if(currentTargetRoom) selectRoom(currentTargetRoom);
                else {
                    chatOutput.innerHTML = ""; // ë‚¨ì€ ë°©ì´ ì—†ìœ¼ë©´ í™”ë©´ ë¹„ì›€
                    renderMySidebar();
                }
            } else {
                renderMySidebar();
            }
        }
    }

    // --- WebSocket ì´ë²¤íŠ¸ ---
    ws.onopen = () => {
        // ì—°ê²°ë˜ë©´ ì±„íŒ…ì°½ ì´ˆê¸°í™”
        chatOutput.innerHTML = "";
        appendToScreen("<div class='system'>ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ì„¸ìš”.</div>");
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        switch (msg.type) {
            case "ROOM_LIST": // ì „ì²´ ë°© ëª©ë¡
                const rooms = msg.payload;
                allRoomListUl.innerHTML = "";
                if(rooms.length === 0) allRoomListUl.innerHTML = "<li style='cursor:default; background:none; border:none; color:#aaa'>ê°œì„¤ëœ ë°© ì—†ìŒ</li>";

                rooms.forEach(r => {
                    const li = document.createElement("li");
                    li.textContent = r;
                    li.onclick = () => {
                        document.getElementById("roomInput").value = r;
                        document.getElementById("joinRoomButton").click();
                    };
                    allRoomListUl.appendChild(li);
                });
                break;

            case "SYSTEM_NOTICE": // ì‹œìŠ¤í…œ ì•Œë¦¼
                const noticeText = msg.payload;
                const sysHtml = `<div class="system">${noticeText}</div>`;

                // 1. ë‹‰ë„¤ì„ ì„¤ì • ì™„ë£Œ ì‹œ
                if (noticeText.includes("ë‹‰ë„¤ì„ì´")) {
                    appendToScreen(sysHtml); // ì´ê±´ í˜„ì¬ í™”ë©´ì— ê·¸ëƒ¥ ë³´ì—¬ì¤Œ
                    document.getElementById("joinRoomButton").disabled = false;
                    document.getElementById("nicknameInput").disabled = true;
                    document.getElementById("setNicknameButton").disabled = true;
                }

                // 2. ë°© ì…ì¥ ("'ë°©ì´ë¦„' ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤")
                else if (noticeText.includes("ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤")) {
                    const match = noticeText.match(/'(.*?)'/);
                    if (match) {
                        const newRoom = match[1];

                        // ë‚´ê°€ ì…ì¥í•œ ê²½ìš°
                        if (!noticeText.includes("ë‹˜ì´")) {
                            if (!myJoinedRooms.includes(newRoom)) {
                                myJoinedRooms.push(newRoom);
                                // ì €ì¥ì†Œ ì´ˆê¸°í™”
                                if (!roomMessages[newRoom]) roomMessages[newRoom] = [];
                                selectRoom(newRoom); // ìë™ ì„ íƒ
                            }
                        }
                        // ë‚¨ì´ ì…ì¥í•œ ê²½ìš° -> í•´ë‹¹ ë°© ë¡œê·¸ì— ì¶”ê°€
                        else {
                             processIncomingMessage(newRoom, sysHtml);
                        }
                    }
                }
                // 3. ë°© í‡´ì¥
                else if (noticeText.includes("í‡´ì¥í–ˆìŠµë‹ˆë‹¤")) {
                     // í˜„ì¬ ì„œë²„ëŠ” "[ë°©ì´ë¦„]"ì„ ì•ˆ ë³´ë‚´ì£¼ë¯€ë¡œ, ê·¸ëƒ¥ í˜„ì¬ ë³´ê³  ìˆëŠ” ë°©ì— ë„ì›€ (í•œê³„)
                     // ë§Œì•½ ì„œë²„ê°€ [ë°©ì´ë¦„]ì„ ë³´ë‚´ì£¼ë©´ processIncomingMessageë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ.
                     if(currentTargetRoom) processIncomingMessage(currentTargetRoom, sysHtml);
                }
                else {
                    // ê·¸ ì™¸ ì•Œë¦¼ì€ í˜„ì¬ ë°©ì— í‘œì‹œ
                    if(currentTargetRoom) processIncomingMessage(currentTargetRoom, sysHtml);
                }
                break;

            case "NEW_MESSAGE": // ì±„íŒ… ìˆ˜ì‹ 
                const chat = msg.payload; // {room, sender, message}
                // HTML ìƒì„±
                const html = `<div class="msg-row"><span class="sender">${chat.sender}:</span> ${chat.message}</div>`;
                // [í•µì‹¬] í•´ë‹¹ ë°© ì €ì¥ì†Œë¡œ ë¼ìš°íŒ…
                processIncomingMessage(chat.room, html);
                break;
        }
    };

    // --- ë²„íŠ¼ ì´ë²¤íŠ¸ ---
    document.getElementById("setNicknameButton").onclick = () => {
        const val = document.getElementById("nicknameInput").value;
        if(val) sendJson("SET_NICKNAME", val);
    };

    document.getElementById("joinRoomButton").onclick = () => {
        const val = document.getElementById("roomInput").value;
        if(val) sendJson("JOIN_ROOM", val);
    };

    sendButton.onclick = () => {
        const text = messageInput.value;
        if (text && currentTargetRoom) {
            const payloadObj = {
                targetRoom: currentTargetRoom,
                message: text
            };
            // ì´ì¤‘ JSON ë¬¸ìì—´í™”
            sendJson("CHAT_MESSAGE", JSON.stringify(payloadObj));
            messageInput.value = "";
        }
    };

    // ì—”í„°í‚¤ ì´ë²¤íŠ¸
    document.getElementById("nicknameInput").onkeyup = (e) => { if(e.key==="Enter") document.getElementById("setNicknameButton").click(); };
    document.getElementById("roomInput").onkeyup = (e) => { if(e.key==="Enter") document.getElementById("joinRoomButton").click(); };
    document.getElementById("messageInput").onkeyup = (e) => { if(e.key==="Enter") sendButton.click(); };

</script>
</body>
</html>