<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¸ìˆ˜ì½”ë“œ - ë©€í‹°ë£¸ ì±„íŒ…</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            height: 95vh;
            margin: 0; padding: 20px; box-sizing: border-box;
        }
        h1 { margin-top: 0; }

        /* UI êµ¬ì—­ ìŠ¤íƒ€ì¼ */
        #nicknameSection, #roomSection {
            margin-bottom: 15px; padding: 15px;
            background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;
        }

        /* ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ (ì¶”ê°€ë¨) */
        #roomList {
            list-style: none; padding: 0; margin: 10px 0;
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        #roomList li {
            background: white; padding: 8px 15px;
            border: 1px solid #ced4da; border-radius: 20px;
            cursor: pointer; transition: all 0.2s; font-size: 0.9em;
        }
        #roomList li:hover {
            background: #007bff; color: white; border-color: #007bff; transform: translateY(-2px);
        }
        #roomList li.empty {
            background: transparent; border: none; cursor: default; color: #6c757d;
        }

        /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        #chatOutput {
            border: 1px solid #ced4da; border-radius: 5px; padding: 15px;
            overflow-y: scroll; background: #fff; margin-bottom: 10px;
        }
        .system { color: #6c757d; font-size: 0.9em; text-align: center; margin: 5px 0; }
        .error { color: #dc3545; font-weight: bold; text-align: center; }
        .message { margin: 8px 0; line-height: 1.4; }
        .sender { font-weight: bold; color: #007bff; margin-right: 5px; }

        /* ì…ë ¥ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .input-group { display: flex; gap: 10px; }
        #chatInput { display: none; } /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        input { flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        button {
            padding: 10px 20px; background: #007bff; color: white; border: none;
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #0056b3; }
    </style>
</head>
<body>

<h1>ë©€í‹°ë£¸ ì±„íŒ…</h1>

<div id="nicknameSection">
    <div class="input-group">
        <input type="text" id="nicknameInput" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button id="setNicknameButton">ë‹‰ë„¤ì„ ì„¤ì •</button>
    </div>
</div>

<div id="roomSection">
    <h3>ğŸŒ í™œì„±í™”ëœ ì±„íŒ…ë°©</h3>
    <ul id="roomList">
        <li class="empty">ì„œë²„ì— ì—°ê²° ì¤‘...</li>
    </ul>

    <div class="input-group" style="margin-top: 10px;">
        <input type="text" id="roomInput" placeholder="ë°© ì´ë¦„ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì—ì„œ ì„ íƒí•˜ì„¸ìš”">
        <button id="joinRoomButton" disabled>ë°© ì°¸ê°€ / ìƒì„±</button>
    </div>
</div>

<div id="chatOutput">
    <p class="system">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
</div>

<div id="chatInput" class="input-group">
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
    <button id="sendButton">ì „ì†¡</button>
</div>

<script>
    const ws = new WebSocket("ws://localhost:8080");

    // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
    const chatOutput = document.getElementById("chatOutput");
    const nicknameInput = document.getElementById("nicknameInput");
    const setNicknameButton = document.getElementById("setNicknameButton");

    // ë°© ê´€ë ¨ ìš”ì†Œ
    const roomListUl = document.getElementById("roomList"); // [ì¶”ê°€ë¨]
    const roomInput = document.getElementById("roomInput");
    const joinRoomButton = document.getElementById("joinRoomButton");

    // ì±„íŒ… ì…ë ¥ ìš”ì†Œ
    const chatInputDiv = document.getElementById("chatInput");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");

    // --- í—¬í¼ í•¨ìˆ˜ ---
    function addLog(message, type = "system") {
        chatOutput.innerHTML += `<div class="${type}">${message}</div>`;
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    function sendMessage(type, payload) {
        if(ws.readyState === WebSocket.OPEN) {
            const msg = { type, payload };
            ws.send(JSON.stringify(msg));
        }
    }

    // [ì¶”ê°€ë¨] ë°© ëª©ë¡ì„ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderRoomList(rooms) {
        roomListUl.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        if (!rooms || rooms.length === 0) {
            roomListUl.innerHTML = '<li class="empty">í˜„ì¬ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</li>';
            return;
        }

        rooms.forEach(roomName => {
            const li = document.createElement("li");
            li.textContent = `ğŸ’¬ ${roomName}`; // ì•„ì´ì½˜ ì¥ì‹

            // [í•µì‹¬] ë°© í´ë¦­ ì‹œ ìë™ìœ¼ë¡œ ì…ë ¥ì°½ ì±„ìš°ê³  ì…ì¥ ë²„íŠ¼ í´ë¦­
            li.onclick = () => {
                roomInput.value = roomName;
                // ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ ì…ì¥ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ì²´í¬
                if(!joinRoomButton.disabled) {
                    joinRoomButton.click();
                } else {
                    alert("ë¨¼ì € ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
                    nicknameInput.focus();
                }
            };
            roomListUl.appendChild(li);
        });
    }

    // --- WebSocket ì´ë²¤íŠ¸ ---
    ws.onopen = () => {
        // ì—°ê²°ë˜ë©´ ì±„íŒ…ì°½ ì´ˆê¸°í™”
        chatOutput.innerHTML = "";
        addLog("ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ì„¸ìš”.");
    };

    ws.onclose = () => {
        addLog("ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.", "error");
        joinRoomButton.disabled = true;
        setNicknameButton.disabled = true;
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        switch (msg.type) {
            case "ROOM_LIST":
                // [ì¶”ê°€ë¨] ì„œë²„ì—ì„œ ì˜¨ ë°© ëª©ë¡ ë°°ì—´ë¡œ í™”ë©´ ê°±ì‹ 
                renderRoomList(msg.payload);
                break;

            case "SYSTEM_NOTICE":
                addLog(msg.payload, "system");

                // ë‹‰ë„¤ì„ ì„¤ì • ì„±ê³µ ì‹œ
                if (msg.payload.includes("ë‹‰ë„¤ì„ì´")) {
                    joinRoomButton.disabled = false; // ë°© ì°¸ê°€ ë²„íŠ¼ í™œì„±í™”
                    nicknameInput.disabled = true;   // ë‹‰ë„¤ì„ ìˆ˜ì • ë¶ˆê°€
                    setNicknameButton.disabled = true;
                    roomInput.focus(); // ë°© ì…ë ¥ì°½ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                }
                // ë°© ì…ì¥ ì„±ê³µ ì‹œ
                if (msg.payload.includes("ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤")) {
                    chatInputDiv.style.display = "flex"; // ì±„íŒ… ì…ë ¥ì°½ ë³´ì´ê¸°
                    messageInput.focus(); // ë©”ì‹œì§€ ì…ë ¥ì°½ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                }
                break;

            case "NEW_MESSAGE":
                const chat = msg.payload;
                addLog(`<span class="sender">${chat.sender}:</span> ${chat.message}`, "message");
                break;

            case "ERROR":
                addLog(`âš ï¸ ${msg.payload}`, "error");
                break;

            default:
                console.log("ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€:", msg);
        }
    };

    // --- UI í´ë¦­ ì´ë²¤íŠ¸ ---
    setNicknameButton.onclick = () => {
        const nickname = nicknameInput.value.trim();
        if (nickname) {
            sendMessage("SET_NICKNAME", nickname);
        } else {
            alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
    };

    joinRoomButton.onclick = () => {
        const room = roomInput.value.trim();
        if (room) {
            sendMessage("JOIN_ROOM", room);
        } else {
            alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
    };

    sendButton.onclick = () => {
        const message = messageInput.value.trim();
        if (message) {
            sendMessage("CHAT_MESSAGE", message);
            messageInput.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        }
    };

    // ì—”í„°í‚¤ ì§€ì›
    nicknameInput.addEventListener("keyup", (e) => { if (e.key === "Enter") setNicknameButton.click(); });
    roomInput.addEventListener("keyup", (e) => { if (e.key === "Enter") joinRoomButton.click(); });
    messageInput.addEventListener("keyup", (e) => { if (e.key === "Enter") sendButton.click(); });

</script>
</body>
</html>