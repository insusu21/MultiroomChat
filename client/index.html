<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>인수코드</title>
    <style>
        body { font-family: sans-serif; display: grid; grid-template-rows: auto auto 1fr auto; height: 95vh; }
        #chatOutput { border: 1px solid #ccc; padding: 10px; overflow-y: scroll; }
        .system { color: gray; font-style: italic; }
        .error { color: red; font-weight: bold; }
        .message { margin: 5px 0; }
        .sender { font-weight: bold; }
        #controls, #chatInput { display: flex; gap: 10px; margin: 10px 0; }
        #chatInput { display: none; }
        input { flex-grow: 1; }
    </style>
</head>
<body>
<h1>멀티룸 채팅 (WebSocket)</h1>

<div id="controls">
    <input type="text" id="nicknameInput" placeholder="닉네임 입력">
    <button id="setNicknameButton">닉네임 설정</button>
    <input type="text" id="roomInput" placeholder="방 이름 입력">
    <button id="joinRoomButton" disabled>방 참가</button>
</div>

<div id="chatOutput">
    <p class="system">서버에 연결 중...</p>
</div>

<div id="chatInput">
    <input type="text" id="messageInput" placeholder="메시지 입력...">
    <button id="sendButton">전송</button>
</div>

<script>
    const ws = new WebSocket("ws://localhost:8080");

    // --- DOM 요소 ---
    const chatOutput = document.getElementById("chatOutput");
    const nicknameInput = document.getElementById("nicknameInput");
    const setNicknameButton = document.getElementById("setNicknameButton");
    const roomInput = document.getElementById("roomInput");
    const joinRoomButton = document.getElementById("joinRoomButton");
    const chatInputDiv = document.getElementById("chatInput");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");

    // --- 헬퍼 함수 ---
    function addLog(message, type = "system") {
        chatOutput.innerHTML += `<p class="${type}">${message}</p>`;
        chatOutput.scrollTop = chatOutput.scrollHeight; // 스크롤 맨 아래로
    }

    // 서버로 JSON 메시지 전송
    function sendMessage(type, payload) {
        const msg = { type, payload };
        ws.send(JSON.stringify(msg));
    }

    // --- WebSocket 이벤트 핸들러 ---
    ws.onopen = () => {
        addLog("서버에 연결되었습니다.");
    };

    ws.onclose = () => {
        addLog("서버와 연결이 끊겼습니다.", "error");
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        switch (msg.type) {
            case "SYSTEM_NOTICE":
                addLog(msg.payload, "system");
                // 닉네임 설정 성공 시
                if (msg.payload.includes("닉네임이")) {
                    joinRoomButton.disabled = false;
                }
                // 방 입장 성공 시
                if (msg.payload.includes("방에 입장했습니다")) {
                    chatInputDiv.style.display = "flex";
                }
                break;
            case "NEW_MESSAGE":
                const chat = msg.payload; // { sender: "...", message: "..." }
                addLog(`<span class="sender">${chat.sender}:</span> ${chat.message}`, "message");
                break;
            case "ERROR":
                addLog(`[에러] ${msg.payload}`, "error");
                break;
            default:
                addLog(`알 수 없는 메시지: ${event.data}`, "error");
        }
    };

    // --- UI 이벤트 핸들러 ---
    setNicknameButton.onclick = () => {
        const nickname = nicknameInput.value;
        if (nickname) {
            sendMessage("SET_NICKNAME", nickname);
        }
    };

    joinRoomButton.onclick = () => {
        const room = roomInput.value;
        if (room) {
            sendMessage("JOIN_ROOM", room);
        }
    };

    sendButton.onclick = () => {
        const message = messageInput.value;
        if (message) {
            sendMessage("CHAT_MESSAGE", message);
            messageInput.value = "";
        }
    };

    // 엔터 키로 메시지 전송
    messageInput.addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
            sendButton.click();
        }
    });

</script>
</body>
</html>